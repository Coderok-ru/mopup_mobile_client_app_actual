# Uncomment this line to define a global platform for your project
platform :ios, '13.0'

ENV['YANDEX_MAPKIT_VARIANT'] = 'full'

# CocoaPods analytics sends network stats synchronously affecting flutter build latency.
ENV['COCOAPODS_DISABLE_STATS'] = 'true'

project 'Runner', {
  'Debug' => :debug,
  'Profile' => :release,
  'Release' => :release,
}

def flutter_root
  generated_xcode_build_settings_path = File.expand_path(File.join('..', 'Flutter', 'Generated.xcconfig'), __FILE__)
  unless File.exist?(generated_xcode_build_settings_path)
    raise "#{generated_xcode_build_settings_path} must exist. If you're running pod install manually, make sure flutter pub get is executed first"
  end

  File.foreach(generated_xcode_build_settings_path) do |line|
    matches = line.match(/FLUTTER_ROOT\=(.*)/)
    return matches[1].strip if matches
  end
  raise "FLUTTER_ROOT not found in #{generated_xcode_build_settings_path}. Try deleting Generated.xcconfig, then run flutter pub get"
end

require File.expand_path(File.join('packages', 'flutter_tools', 'bin', 'podhelper'), flutter_root)

flutter_ios_podfile_setup

target 'Runner' do
  use_frameworks!

  flutter_install_all_ios_pods File.dirname(File.realpath(__FILE__))
  target 'RunnerTests' do
    inherit! :search_paths
  end
end

post_install do |installer|
  installer.pods_project.targets.each do |target|
    flutter_additional_ios_build_settings(target)
  end
  
  # –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–µ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –ø—Ä–æ–±–ª–µ–º —Å GCC_PREPROCESSOR_DEFINITIONS –≤ .xcconfig —Ñ–∞–π–ª–∞—Ö
  puts "üîß –ò—Å–ø—Ä–∞–≤–ª—è—é –ø—Ä–æ–±–ª–µ–º—ã —Å .xcconfig —Ñ–∞–π–ª–∞–º–∏..."
  
  xcconfig_files = Dir.glob(File.join(installer.sandbox.root, "Target Support Files", "**", "*.xcconfig"))
  
  xcconfig_files.each do |file|
    lines = File.readlines(file)
    original_lines = lines.dup
    modified = false
    
    lines.each_with_index do |line, index|
      original_line = line.dup
      had_newline = line.end_with?("\n")
      
      # –£–¥–∞–ª—è–µ–º —Å–∏–º–≤–æ–ª –Ω–æ–≤–æ–π —Å—Ç—Ä–æ–∫–∏ –¥–ª—è –æ–±—Ä–∞–±–æ—Ç–∫–∏
      line = line.chomp
      
      # –£–¥–∞–ª—è–µ–º –ø—Ä–æ–±–µ–ª—ã –≤ –∫–æ–Ω—Ü–µ —Å—Ç—Ä–æ–∫–∏
      line.gsub!(/[[:space:]]+$/, '')
      
      # –î–ª—è GCC_PREPROCESSOR_DEFINITIONS —É–¥–∞–ª—è–µ–º –ø—Ä–æ–±–µ–ª—ã –≤–æ–∫—Ä—É–≥ = –≤ –æ–ø—Ä–µ–¥–µ–ª–µ–Ω–∏—è—Ö
      # –§–æ—Ä–º–∞—Ç –¥–æ–ª–∂–µ–Ω –±—ã—Ç—å NAME=VALUE (–±–µ–∑ –ø—Ä–æ–±–µ–ª–æ–≤ –≤–æ–∫—Ä—É–≥ =)
      if line.match(/^GCC_PREPROCESSOR_DEFINITIONS\s*=\s*(.*)$/)
        definitions = $1.strip
        # –£–¥–∞–ª—è–µ–º –ø—Ä–æ–±–µ–ª—ã –≤–æ–∫—Ä—É–≥ = –≤ –∫–∞–∂–¥–æ–º –æ–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–∏ –º–∞–∫—Ä–æ—Å–∞
        # –û–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ–º –∑–Ω–∞—á–µ–Ω–∏—è —Å –∫–∞–≤—ã—á–∫–∞–º–∏ –∏ –±–µ–∑ –Ω–∏—Ö
        # –ü–∞—Ç—Ç–µ—Ä–Ω: –ò–ú–Ø = "–∑–Ω–∞—á–µ–Ω–∏–µ" –∏–ª–∏ –ò–ú–Ø = –∑–Ω–∞—á–µ–Ω–∏–µ
        fixed_definitions = definitions.gsub(/([A-Za-z0-9_]+)\s*=\s*/, '\1=')
        line = "GCC_PREPROCESSOR_DEFINITIONS = #{fixed_definitions}"
        
        # –£–¥–∞–ª—è–µ–º –¥—É–±–ª–∏—Ä—É—é—â–∏–µ—Å—è $(inherited)
        line.gsub!(/\$\(inherited\)[[:space:]]*COCOAPODS=1[[:space:]]*\$\(inherited\)/, '$(inherited) COCOAPODS=1')
        while line.include?('$(inherited) $(inherited)')
          line.gsub!(/\$\(inherited\)[[:space:]]+\$\(inherited\)/, '$(inherited)')
        end
        
        # –ò—Å–ø—Ä–∞–≤–ª—è–µ–º –æ—Ç—Å—É—Ç—Å—Ç–≤–∏–µ –ø—Ä–æ–±–µ–ª–∞ –º–µ–∂–¥—É –æ–ø—Ä–µ–¥–µ–ª–µ–Ω–∏—è–º–∏ (=1[A-Z] -> =1 [A-Z])
        line.gsub!(/=1([A-Z_])/, '=1 \1')
        
        # –ò—Å–ø—Ä–∞–≤–ª—è–µ–º GDTCOR_VERSION
        line.gsub!(/GDTCOR_VERSION=1[[:space:]]+0\.1\.0/, 'GDTCOR_VERSION=10.1.0')
      else
        # –î–ª—è –æ—Å—Ç–∞–ª—å–Ω—ã—Ö —Å—Ç—Ä–æ–∫ –Ω–æ—Ä–º–∞–ª–∏–∑—É–µ–º —Ñ–æ—Ä–º–∞—Ç (NAME = VALUE —Å –ø—Ä–æ–±–µ–ª–∞–º–∏)
        line.gsub!(/^([A-Za-z0-9_]+)\s*=\s*(.*)$/, '\1 = \2') if line.match(/^[A-Za-z0-9_]+\s*=/)
      end
      
      # –í–æ—Å—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º —Å–∏–º–≤–æ–ª –Ω–æ–≤–æ–π —Å—Ç—Ä–æ–∫–∏
      lines[index] = line + "\n"
      modified = true if line != original_line.chomp
    end
    
    if modified
      File.write(file, lines.join(''))
      puts "‚úÖ –ò—Å–ø—Ä–∞–≤–ª–µ–Ω: #{file}"
    end
  end
  
  puts "‚úÖ –ò—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–µ .xcconfig —Ñ–∞–π–ª–æ–≤ –∑–∞–≤–µ—Ä—à–µ–Ω–æ!"
end
